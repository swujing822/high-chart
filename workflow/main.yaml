name: Auto Release csv_orderbooks (every 4 hours)

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯ 2 å°æ—¶ UTC æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ•’ Record start time
        id: record_start
        run: echo "start_time=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: â¬‡ï¸ Clone swujing822/simple-ccxt
        run: |
          git clone https://github.com/swujing822/simple-ccxt.git source-repo

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Python dependencies
        working-directory: source-repo
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "âš ï¸ requirements.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡"

      - name: â–¶ï¸ Run watch_orderbooks.py
        working-directory: source-repo/src
        run: |
          python watch_orderbooks.py

      - name: ğŸ§­ List files in source-repo/src
        run: |
          echo "ğŸ“ å½“å‰è·¯å¾„:"
          pwd
          echo "ğŸ“„ æ–‡ä»¶åˆ—è¡¨:"
          ls -al source-repo/src

      - name: ğŸ•“ Record end time
        id: record_end
        run: echo "end_time=$(date -u +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Create release tag from start~end time
        id: set_tag
        run: |
          TAG="auto-${{ steps.record_start.outputs.start_time }}_${{ steps.record_end.outputs.end_time }}"
          echo "tag_name=$TAG" >> $GITHUB_OUTPUT

      - name: ğŸš€ Upload to swujing822/target Release
        uses: softprops/action-gh-release@v2
        with:
          repository: swujing822/target
          tag_name: ${{ steps.set_tag.outputs.tag_name }}
          name: Release ${{ steps.set_tag.outputs.tag_name }}
          body: |
            è‡ªåŠ¨æ‰§è¡Œæ—¶é—´èŒƒå›´ï¼š  
            å¼€å§‹ï¼š${{ steps.record_start.outputs.start_time }}  
            ç»“æŸï¼š${{ steps.record_end.outputs.end_time }}
          files: |
            source-repo/src/csv_orderbooks_exchange_*.zip
            source-repo/src/csv_orderbooks_symbol_*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
