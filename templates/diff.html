<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>现货 vs 期货 价格对比 + 基差（可切换合约）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #controls {
      margin: 10px 0;
    }
    button, input {
      padding: 6px 12px;
      font-size: 16px;
      margin-right: 10px;
    }
    input {
      width: 120px;
    }
  </style>
</head>
<body>
  <h2>现货 vs 永续合约价格（1分钟） + 基差（百分比）</h2>

  <div id="controls">
    <label for="symbolInput">交易对（symbol）:</label>
    <input type="text" id="symbolInput" value="BTCUSDT" />
    <label for="limitInput">单次获取K线数量:</label>
    <input type="number" id="limitInput" min="1" max="1000" value="100" />
    <button id="refreshBtn">刷新数据</button>
    <button id="prevBtn">⬅️ 后退</button>
    <button id="nextBtn">➡️ 前进</button>
  </div>

  <canvas id="priceChart" width="1000" height="450"></canvas>

  <script>
    let endTime = undefined;
    let limit = 100;
    let chart = null;
    let symbol = 'BTCUSDT';

    async function fetchKlines(url, endTime, limit) {
      let fullUrl = url + `&limit=${limit}`;
      if (endTime) {
        fullUrl += `&endTime=${endTime}`;
      }
      const res = await fetch(fullUrl);
      const data = await res.json();
      return data.map(d => ({
        time: new Date(d[0]),
        close: parseFloat(d[4]),
        rawTime: d[0]
      }));
    }

    function alignData(spotData, futuresData) {
      const futuresMap = new Map(futuresData.map(d => [d.rawTime, d.close]));
      return spotData
        .filter(d => futuresMap.has(d.rawTime))
        .map(d => ({
          time: d.time,
          spot: d.close,
          futures: futuresMap.get(d.rawTime),
          basisPercent: ((futuresMap.get(d.rawTime) - d.close) / d.close) * 100
        }));
    }

    function drawChart(alignedData) {
      const labels = alignedData.map(d => {
        const h = d.time.getHours();
        const m = d.time.getMinutes().toString().padStart(2, '0');
        return `${h}:${m}`;
      });
      const spotPrices = alignedData.map(d => d.spot);
      const futuresPrices = alignedData.map(d => d.futures);
      const basisPercents = alignedData.map(d => d.basisPercent);

      const ctx = document.getElementById('priceChart').getContext('2d');
      if (chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = spotPrices;
        chart.data.datasets[1].data = futuresPrices;
        chart.data.datasets[2].data = basisPercents;
        chart.update('none');  // 禁用动画
      } else {
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: '现货价格 (' + symbol + ')',
                data: spotPrices,
                borderColor: 'blue',
                borderWidth: 2,
                fill: false,
                tension: 0.3,
                yAxisID: 'y',
              },
              {
                label: '永续合约价格 (' + symbol + ' Perp)',
                data: futuresPrices,
                borderColor: 'red',
                borderWidth: 2,
                fill: false,
                tension: 0.3,
                yAxisID: 'y',
              },
              {
                label: '基差百分比 (%)',
                data: basisPercents,
                borderColor: 'green',
                borderWidth: 2,
                fill: false,
                tension: 0.3,
                yAxisID: 'y1',
              },
            ],
          },
          options: {
            animation: false,
            responsive: true,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            stacked: false,
            plugins: {
              title: {
                display: true,
                text: symbol + ' 现货 vs 永续合约 + 基差百分比',
              },
              legend: {
                position: 'top',
              },
            },
            scales: {
              x: {
                display: true,
                title: {
                  display: true,
                  text: '时间',
                },
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: '价格 (USDT)',
                },
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                grid: {
                  drawOnChartArea: false,
                },
                title: {
                  display: true,
                  text: '基差百分比 (%)',
                },
                ticks: {
                  callback: function(value) {
                    return value.toFixed(2) + '%';
                  }
                }
              },
            },
          },
        });
      }
    }

    async function loadData() {
      symbol = document.getElementById('symbolInput').value.trim().toUpperCase();
      limit = parseInt(document.getElementById('limitInput').value, 10);
      if (!symbol) {
        alert('请输入交易对symbol');
        return;
      }
      if (isNaN(limit) || limit < 1 || limit > 1000) {
        alert('请输入 1 到 1000 之间的有效数字');
        return;
      }

      const spotUrl = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1m`;
      const futuresUrl = `https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1m`;

      const [spotData, futuresData] = await Promise.all([
        fetchKlines(spotUrl, endTime, limit),
        fetchKlines(futuresUrl, endTime, limit),
      ]);

      if (spotData.length === 0 || futuresData.length === 0) {
        alert("没有更多数据了，或者交易对不存在！");
        return;
      }

      endTime = spotData[0].rawTime - 1;

      const alignedData = alignData(spotData, futuresData);
      drawChart(alignedData);
    }

    document.getElementById('prevBtn').addEventListener('click', () => {
      loadData();
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
      endTime = undefined;
      loadData();
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
      endTime = undefined;
      loadData();
    });

    // 初始加载
    loadData();
  </script>
</body>
</html>
